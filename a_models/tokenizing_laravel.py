# Import
import mysql.connector  
import time
 
def last_id(space):  
    # ----------------------------------------------------------    
    space += "__"
    # ---------------------------------------------------------- 
    print(space + "last_id()", flush=True)
    # ----------------------------------------------------------   
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database)
    # ----------------------------------------------------------   
    query = "SELECT fk_id FROM `datasets` order by fk_id desc limit 1"    
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    print(space + query)
    # ----------------------------------------------------------    
    mycursor = mydb.cursor()
    mycursor.execute(query) 
    result_check = mycursor.fetchone()
    # ---------------------------------------------------------- 
    mycursor.close()
    mydb.close()
    # ----------------------------------------------------------    
    space += "__"
    # ----------------------------------------------------------   
    last_id = result_check[0] 
    # ---------------------------------------------------------- 
    print(space + "Last ID:" + str(last_id), flush=True) 
    # ----------------------------------------------------------   
    return last_id
    # ---------------------------------------------------------- 
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  

def data_raw(entity, last_idx, limitx, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    print(space + "data_raw()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------   
    query = "Select " 
    query += " fk_id "   
    query += " , dataset "     
    query += " from " + entity       
    query += " where fk_id > " + str(last_idx)      
    query += " limit " + str(limitx)         
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    print(space + query)
    # ----------------------------------------------------------   
    mycursor = mydb.cursor()
    mycursor.execute(query)
    result =  mycursor.fetchall()
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    total_rows = len(result)
    print(space + "Total Row(s) : " + str(total_rows), flush=True) 
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ---------------------------------------------------------- 
    counter = 0 
    # ----------------------------------------------------------
    for x in result:     
        # ------------------------------------------------------
        counter += 1
        # ------------------------------------------------------
        fk_id       = str(x[0])   
        dataset     = str(x[1].strip())       
        # ------------------------------------------------------  
        word = space + "__[" + str(counter) + "/" +str(total_rows) + "] "
        word += " #" + fk_id  
        word += " __ " + dataset    
        # ------------------------------------------------------   
        if(counter % (limitx / 10) == 0):
            print(word, flush=True)    
        # ------------------------------------------------------     
        tokenizing(fk_id, dataset, space)
        # ------------------------------------------------------   
        # time.sleep(0.05) 
        # ------------------------------------------------------   
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  

    
def tokenizing(FK_id, dataset, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    # print(space + "tokenizing()", flush=True)
    # ---------------------------------------------------------- 
    token_dataset      = dataset.split(" ") 
    # ----------------------------------------------------------  
    for token in token_dataset:
        # ------------------------------------------------------
        time.sleep(0.00005) 
        # ------------------------------------------------------
        word = space + "________  "   
        word += token  
        # print(word, flush=True)    
        # ------------------------------------------------------
        # time.sleep(0.05) 
        # ------------------------------------------------------
        insert_dataset(FK_id, token, space)
        # ------------------------------------------------------
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------   

    
def insert_dataset(FK_id, token, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + "insert_token()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------  
    query_commit = "INSERT INTO `datasets` ("
    # ----------------------------------------------------------   
    query_commit += " `fk_id`, "  
    query_commit += " `name` "  
    query_commit += " ) VALUES ( "  
    query_commit += " '" + str(FK_id) + "', "  
    query_commit += ' "' + str(token).replace("'", "\\'") + '" '  
    query_commit += " ) "   
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + query_commit, flush=True)
    # ----------------------------------------------------------  
    mycursor = mydb.cursor()
    mycursor.execute(query_commit)
    mydb.commit()     
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------   

def last_id_jobtitle(space):  
    # ----------------------------------------------------------    
    space += "__"
    # ---------------------------------------------------------- 
    print(space + "last_id()", flush=True)
    # ----------------------------------------------------------   
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database)
    # ----------------------------------------------------------   
    query = "SELECT fk_id FROM `dataset_jobtitle` order by fk_id desc limit 1"    
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    print(space + query)
    # ----------------------------------------------------------    
    mycursor = mydb.cursor()
    mycursor.execute(query) 
    result_check = mycursor.fetchone()
    # ---------------------------------------------------------- 
    mycursor.close()
    mydb.close()
    # ----------------------------------------------------------    
    space += "__"
    # ----------------------------------------------------------   
    last_id = result_check[0] 
    # ---------------------------------------------------------- 
    print(space + "Last ID:" + str(last_id), flush=True) 
    # ----------------------------------------------------------   
    return last_id
    # ---------------------------------------------------------- 
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    
def data_raw_jobtitle(entity, last_idx, limitx, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    print(space + "data_raw_jobtitle()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------   
    query = "Select " 
    query += " fk_id "   
    query += " , dataset "     
    query += " from " + entity       
    query += " where fk_id > " + str(last_idx)      
    query += " limit " + str(limitx)         
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    print(space + query)
    # ----------------------------------------------------------   
    mycursor = mydb.cursor()
    mycursor.execute(query)
    result =  mycursor.fetchall()
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    total_rows = len(result)
    print(space + "Total Row(s) : " + str(total_rows), flush=True) 
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ---------------------------------------------------------- 
    counter = 0 
    # ----------------------------------------------------------
    for x in result:     
        # ------------------------------------------------------
        counter += 1
        # ------------------------------------------------------
        fk_id       = str(x[0])   
        dataset     = str(x[1].strip())       
        # ------------------------------------------------------  
        word = space + "__[" + str(counter) + "/" +str(total_rows) + "] "
        word += " #" + fk_id  
        word += " __ " + dataset    
        # ------------------------------------------------------   
        if(counter % (limitx / 10) == 0):
            print(word, flush=True)    
        # ------------------------------------------------------     
        tokenizing_jobtitle(fk_id, dataset, space)
        # ------------------------------------------------------   
        # time.sleep(0.05) 
        # ------------------------------------------------------   
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  

     
def tokenizing_jobtitle(FK_id, dataset, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    # print(space + "tokenizing()", flush=True)
    # ---------------------------------------------------------- 
    token_dataset      = dataset.split(" ") 
    # ----------------------------------------------------------  
    for token in token_dataset:
        # ------------------------------------------------------
        time.sleep(0.00005) 
        # ------------------------------------------------------
        word = space + "________  "   
        word += token  
        # print(word, flush=True)    
        # ------------------------------------------------------
        # time.sleep(0.05) 
        # ------------------------------------------------------
        insert_dataset_jobtitle(FK_id, token, space)
        # ------------------------------------------------------
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------   

    
def insert_dataset_jobtitle(FK_id, token, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + "insert_token()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------  
    query_commit = "INSERT INTO `dataset_jobtitle` ("
    # ----------------------------------------------------------   
    query_commit += " `fk_id`, "  
    query_commit += " `name` "  
    query_commit += " ) VALUES ( "  
    query_commit += " '" + str(FK_id) + "', "  
    query_commit += ' "' + str(token).replace("'", "\\'") + '" '  
    query_commit += " ) "   
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + query_commit, flush=True)
    # ----------------------------------------------------------  
    mycursor = mydb.cursor()
    mycursor.execute(query_commit)
    mydb.commit()     
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------   