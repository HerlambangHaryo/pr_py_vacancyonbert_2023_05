# Import
import mysql.connector  
import time
  
def detect(table, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    print(space + "detect()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------   
    query = "Select " 
    query += " id "   
    query += " , nama "    
    query += " , label "      
    query += " from anotasis "      
    query += " where nama like '~%' "     
    query += " and done is null "     
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    print(space + query)
    # ----------------------------------------------------------   
    mycursor = mydb.cursor()
    mycursor.execute(query)
    result =  mycursor.fetchall()
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    total_rows = len(result)
    print(space + "Total Row(s) : " + str(total_rows), flush=True) 
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ---------------------------------------------------------- 
    counter = 0 
    # ----------------------------------------------------------
    for x in result:     
        # ------------------------------------------------------
        time.sleep(0.05)
        # ------------------------------------------------------
        counter         += 1  
        # ------------------------------------------------------
        idx         = x[0]   
        nama        = str(x[1].strip())     
        label       = str(x[2].strip())     
        # ------------------------------------------------------   
        word = space + "__[" + str(counter) + "/" +str(total_rows) + "] "
        word += " #" + str(idx)  
        word += " __ " + nama    
        word += " __ " + label         
        print(word, flush=True)    
        # ------------------------------------------------------ 
        entity = nama.split(" ")
        # ------------------------------------------------------ 
        auto_detect(table, entity[1], label, space)
        # ------------------------------------------------------  
        updated_anotasi(idx, space) 
        # ------------------------------------------------------   
    # ----------------------------------------------------------
    # ----------------------------------------------------------
    # ----------------------------------------------------------

def updated_anotasi(idx, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + "updated_anotasi()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------  
    query_commit = "UPDATE `anotasis` SET "
    # ----------------------------------------------------------   
    query_commit += " `done` = 1 "    
    # ----------------------------------------------------------   
    query_commit += " WHERE id = '" + str(idx) + "' "  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + query_commit, flush=True)
    # ----------------------------------------------------------  
    mycursor = mydb.cursor()
    mycursor.execute(query_commit)
    mydb.commit()     
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------

def auto_detect(table, entity, named_entity, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    print(space + "auto_detect()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------   
    query = "Select " 
    query += " id "   
    query += " , name "      
    query += " from " + table      
    query += " where name like '"+entity+"' "    
    query += " and "+named_entity+" = 'O' "    
    # query += " limit 30 "  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    print(space + query)
    # ----------------------------------------------------------   
    mycursor = mydb.cursor()
    mycursor.execute(query)
    result =  mycursor.fetchall()
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    total_rows = len(result)
    print(space + "Total Row(s) : " + str(total_rows), flush=True) 
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ---------------------------------------------------------- 
    counter = 0 
    # ----------------------------------------------------------
    for x in result:     
        # ------------------------------------------------------
        time.sleep(0.05)
        # ------------------------------------------------------
        counter         += 1  
        # ------------------------------------------------------
        idx         = x[0]   
        nama        = str(x[1].strip())      
        # ------------------------------------------------------   
        word = space + "__[" + str(counter) + "/" +str(total_rows) + "] "
        word += " #" + str(idx)  
        word += " __ " + nama         
        # print(word, flush=True)    
        # ------------------------------------------------------   
        pre_dot_id = detect_pre_dot(table, idx, space)
        # ------------------------------------------------------   
        if(pre_dot_id != "X"):
            # --------------------------------------------------   
            word = space + str(pre_dot_id)    
            # print(word, flush=True)    
            # --------------------------------------------------   
            before_dot_id = detect_before_dot(table, idx, space)
            # --------------------------------------------------   
            if(before_dot_id != "X"): 
                # ----------------------------------------------  
                time.sleep(0.05)
                update_begining(table, idx, named_entity, space)
                # ----------------------------------------------   
                time.sleep(0.05)
                update_inside(table, idx, before_dot_id, named_entity, space)
                # ----------------------------------------------  
            # --------------------------------------------------   
        # ------------------------------------------------------   
        # word = space    
        # print(word, flush=True)    
        # ------------------------------------------------------   
    # ----------------------------------------------------------
    # ----------------------------------------------------------
    # ----------------------------------------------------------
 
def detect_pre_dot(table, PARAM_idx, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    # print(space + "detect_pre_dot()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------   
    query = "Select " 
    query += " id "   
    query += " , name "      
    query += " from " + table      
    query += " where id < '"+str(PARAM_idx)+"' "    
    query += " order by id desc "    
    query += " limit 1 "  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    # print(space + query)
    # ----------------------------------------------------------   
    mycursor = mydb.cursor()
    mycursor.execute(query)
    result =  mycursor.fetchall()
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    total_rows = len(result)
    # print(space + "Total Row(s) : " + str(total_rows), flush=True) 
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ---------------------------------------------------------- 
    counter = 0 
    # ----------------------------------------------------------
    for x in result:    
        # ------------------------------------------------------
        counter         += 1  
        # ------------------------------------------------------
        idx         = x[0]   
        nama        = str(x[1].strip())      
        # ------------------------------------------------------   
        word = space + "__[" + str(counter) + "/" +str(total_rows) + "] "
        word += " #" + str(idx)  
        word += " __ " + nama    
        # ------------------------------------------------------   
        # print(word, flush=True)    
        # ------------------------------------------------------   
    # ----------------------------------------------------------
    if(nama == "."):
        return idx
    else:
        return "X"
    # ----------------------------------------------------------
    # ----------------------------------------------------------
    # ----------------------------------------------------------
 
def detect_before_dot(table, PARAM_idx, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    # print(space + "detect_before_dot()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------   
    query = "Select " 
    query += " id "   
    query += " , name "      
    query += " from " + table      
    query += " where id > '"+str(PARAM_idx)+"' "   
    query += " and name = '.' "   
    query += " order by id asc "    
    query += " limit 1 "  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------   
    # print(space + query)
    # ----------------------------------------------------------   
    mycursor = mydb.cursor()
    mycursor.execute(query)
    result =  mycursor.fetchall()
    # ----------------------------------------------------------   
    space += "__"
    # ---------------------------------------------------------- 
    total_rows = len(result)
    # print(space + "Total Row(s) : " + str(total_rows), flush=True) 
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ---------------------------------------------------------- 
    counter = 0 
    # ----------------------------------------------------------
    for x in result:    
        # ------------------------------------------------------
        counter         += 1  
        # ------------------------------------------------------
        idx         = x[0]  
        nama        = str(x[1].strip())      
        # ------------------------------------------------------   
        word = space + "__[" + str(counter) + "/" +str(total_rows) + "] "
        word += " #" + str(idx)   
        word += " __ " + nama    
        word += " __ " + str(idx - PARAM_idx)    
        # ------------------------------------------------------   
        # print(word, flush=True)    
        # ------------------------------------------------------   
    # ----------------------------------------------------------
    if(nama == "."):
        return idx
    else:
        return "X"
    # ----------------------------------------------------------
    # ----------------------------------------------------------
    # ----------------------------------------------------------
 
def update_begining(table, idx, named_entity, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + "update_begining()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------  
    query_commit = "UPDATE `"+table+"` SET "
    # ----------------------------------------------------------   
    query_commit += " `" + str(named_entity) + "` = 'B' "    
    # ----------------------------------------------------------   
    query_commit += " WHERE id = " + str(idx) + " "  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + query_commit, flush=True)
    # ----------------------------------------------------------  
    mycursor = mydb.cursor()
    mycursor.execute(query_commit)
    mydb.commit()     
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------
 
def update_inside(table, idxA, idxB, named_entity, space):  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + "update_inside()", flush=True)
    # ----------------------------------------------------------  
    host="localhost"
    user="root" 
    database="pr_laravel_8_vacancyonbert_2023_05"
    mydb = mysql.connector.connect(host=host,user=user,password="",database=database) 
    # ----------------------------------------------------------  
    query_commit = "UPDATE `"+table+"` SET "
    # ----------------------------------------------------------   
    query_commit += " `" + str(named_entity) + "` = 'I' "    
    # ----------------------------------------------------------   
    query_commit += " WHERE id > " + str(idxA) + " "  
    query_commit += " and id < " + str(idxB) + " "  
    # ----------------------------------------------------------   
    space += "__"
    # ----------------------------------------------------------  
    # print(space + query_commit, flush=True)
    # ----------------------------------------------------------  
    mycursor = mydb.cursor()
    mycursor.execute(query_commit)
    mydb.commit()     
    # ----------------------------------------------------------  
    mycursor.close()
    mydb.close()
    # ----------------------------------------------------------  
    # ----------------------------------------------------------  
    # ----------------------------------------------------------